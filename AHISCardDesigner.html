<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="js/photobooth_min.js"></script>
<script type="text/javascript" src="js/jquery-ui.min.js"></script>
<script type="text/javascript" src="js/jquery.csv-0.71.min.js"></script>
<script type="text/javascript" src="js/JsBarcode/CODE128.js"></script>
<script type="text/javascript" src="js/JsBarcode/JsBarcode.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" type="text/css" href="css/ahis-pickup.css">

</head>
<body>
<div id="container" style="display:block;">
    <div class="card">
        <div class="logo"><img src = "img/ahis-pickup-logo.png" class = "logoimg" style="width: 100%"></div>
          <div class="name">Input a Name</div>
        <div class="photo"><img class="cover" src="img/nophoto.jpg"/></div>
        <div class="title">is authorized to collect:</div>
        <div class="cardbody">

                <p>Name 1</p>
                <p>Name 2</p>
                <p>Name 3</p>
                <p>Name 4</p>
                <p>Name 5</p>
                <p>Name 6</p>

        </div>
        <div class="footer"><img class="footerimg" src = "img/ahis-pickup-footer.png" style="width: 100%"/> </div>
    </div>

</div>

<div id="controls" style="position: absolute; left: 600px;">
<h2>CSV Data</h2>
<textarea id="csvdata" rows="4" cols="50">uid,employeenumber,sn,givenName</textarea>
<button id="csvgenerate" class="btn btn-primary">Mass generate</button>
</div>

</body>
<script type='text/javascript'>
    $("#barcodeimg").JsBarcode($('#inputbarcodenumber').val(),{width:1,height:$('.barcode').height(),backgroundColor:'#FFFFFF'});
    var bcnum_pre = "";
    var bcnum_post= "";
    var departmnettag = "";
    var cardtemplate = `
    <div class='card'>
        <div class='logo'><img src = 'img/logoslogo.png' class = 'logoimg' style='width: 100%'></div>
        <div class='photo'><img src="../img/nophoto.jpg"/></div>
        <div class='name'>Input a Name</div>
        <div class='title'>Staff</div>
        <div class='barcode'></div>
        <div class='barcodenumber'>123</div>
        <div class='cardbody'>
          <ul>
            <li id='dob'>DOB: 15-08-1981</li>
            <li>Emergency Contact:</li>
            <li id='econtact1'>017-XXX-XXXX</li>
            <li id='econtact2'>024-XXX-XXXX</li>
          </ul>
        </div>
        <div class='footer'><img class='footerimg' src = 'img/logoslibraryfooter.png' style='width: 100%'/> </div>
    </div>
    `;
    $('#photoControl').draggable({
        drag: function(){
           var position = $(this).position()
           $('.cover').css('object-position',position.left+'px '+position.top+'px');
        }
    });
    //allows downloading of webcam picture
    function downloadURI(uri, name) {
        var link = document.createElement("a");
        link.download = name;
        link.href = uri;
        link.click();
    }

    $(function() {

    $('#webcam').photobooth().on("image",function(event, dataUrl){
        $('.cover').attr('src',dataUrl);
        var filename = $('#inputname').val()+'.png';
        //downloadURI(dataUrl, filename);
    });
    $("#uploadFile").on("change", function()
        {
                var files = !!this.files ? this.files : [];
                if (!files.length || !window.FileReader) return; // no file selected, or no FileReader support

                if (/^image/.test( files[0].type)){ // only image file
                    var reader = new FileReader(); // instance of the FileReader
                    reader.readAsDataURL(files[0]); // read the local file

                    reader.onloadend = function(){ // set image data as background of div
                        $(".cover").attr("src", this.result);
                    }
                }
    });

    var switchTemplate = function(templatename){

        //css should have just one file: <templatename>.css
        var css_path = 'css/';
        //link in the css
        $('link').attr('href',css_path+templatename+".css");

        /*
           img should have a number of files:
           - <template>-logo.png
           - <template>-footer.png
           - <template>-watermark.png <- this is set in the .css
        */
        var img_path = 'img/';
        $('.footerimg').attr('src',img_path+templatename+'-footer.png');
        $('.logoimg').attr('src',img_path+templatename+'-logo.png');
    };

    $('.template_switch').click(function(){
      // id of element should be related to the name of the .css and images to be loaded
      var templatename = $(this).attr('id');
      switchTemplate(templatename);
      //reset barcode
      $('.barcode').html('<img id="barcodeimg" />');
      $("#barcodeimg").JsBarcode($('#inputbarcodenumber').val(),{width:1,height:$('.barcode').height(),backgroundColor:'#FFFFFF'});
    });

    //Doesn't work with current way of generating barcodes
    $('#csvgenerate').click(function(){
       var cards = $.csv.toArrays($('#csvdata').val());
       for(var i=0; i<cards.length; i++){
              var uid = cards[i][0];
              var employeenumber= cards[i][1];
              var sn = cards[i][2];
              var givenName= cards[i][3];
              var $card = $($.parseHTML(cardtemplate));
              $card.find(".name").text(sn+', '+givenName);
              //$card.find('.barcodenumber').html(bcnum_pre+employeenumber+bcnum_post);
              //$card.find('.barcode').html('<img src="'+bcurl+'?text='+employeenumber+'&size='+bcsize+'"/>');
              $card.find(".photo").css("background-image", "url('http://192.168.0.19/files/"+employeenumber+"/"+employeenumber+"-"+uid+"-Photo.jpg"+"')");
              $('#container').append($card);
              console.log($card.find(".name").text());


       }
    });

    $('#inputname').on("change", function(){
        $('.name').html($('#inputname').val());
    });
    $('#inputtitle').on("change", function(){
        $('.title').html(departmenttag+$('#inputtitle').val());
    });
    $('#inputecontact1').on("change", function(){
        $('#econtact1').html($('#inputecontact1').val());
    });

    $('#inputecontact2').on("change", function(){
        $('#econtact2').html($('#inputecontact2').val());
    });

    $('#inputdob').on("change", function(){
        $('#dob').html('DOB: '+$('#inputdob').val());
    });

    $('#inputbarcodenumber').on("change", function(){
        //reset barcode
        $('.barcodenumber').html($('#inputbarcodenumber').val());
        $('.barcode').html('<img id="barcodeimg" />');
        $("#barcodeimg").JsBarcode($('#inputbarcodenumber').val(),{width:1,height:$('.barcode').height(),backgroundColor:'#FFFFFF'});


    });
});

</script>
</html>
